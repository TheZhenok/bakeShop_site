<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Charge</title>
  <style>
    .loading{
      position: fixed;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
      background-color: rgba(0, 0, 0, 0.37);
      visibility: hidden;
      opacity: 0;
    }
    .loading.active{
      visibility: visible;
      opacity: 1;
    }
    .hidden{
      visibility: hidden;
      opacity: 0;
    }
  </style>
  <!--Bootstrap 4 CSS-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--Bootstrap 4 JavaScript-->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <!--Stripe JavaScript Library-->
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-light pt-5">

<!--hero section-->
<section class="py-5">
  <div class="container">
    <div class="row">
      <div class="col-lg-6 col-md-8 col-12 my-auto mx-auto">
        <h1>
          Stripe Payment
        </h1>
        <p class="lead mb-4">
          Пожалуйста, заполните форму ниже, чтобы завершить оплату заказа
        </p>
        <div class="card mb-4">
          <div class="card-body">
            <h5 th:text="${product.getName()}">Leather Bag</h5>
            <p class="lead" ><span th:text="${product.getPriceValue()}"></span> KZT <span class="hidden" th:text="${product.getId()}"></span></p>
          </div>
        </div>
        <form action="#" id="payment-form" method="post">
          <input id="api-key" type="hidden" th:value="${stripePublicKey}">
          <div class="form-group">
            <label class="font-weight-medium" for="card-element">
              Введите данные кредитной карты
            </label>
            <div class="w-100" id="card-element">
              <!-- A Stripe Element will be inserted here. -->
            </div>
          </div>
          <div class="form-group">
            <input class="form-control" id="email" name="email"
                   placeholder="Email Address" type="email" required>
          </div>
          <!-- Used to display Element errors. -->
          <div class="text-danger w-100" id="card-errors" role="alert"></div>
          <div class="form-group pt-2">
            <button class="btn btn-primary btn-block" id="submitButton" type="submit">
              Оплатить с помощью карты
            </button>
            <div class="small text-muted mt-2">
              Платите безопасно с помощью Stripe. Нажав на кнопку выше, вы соглашаетесь
              к нашей политики <a target="_blank" href="#"></a>,
              <a target="_blank" href="#">Конфиденциальности</a> и
              <a target="_blank" href="#">Возврата</a>.

            </div>
          </div>


        </form>

      </div>
    </div>
  </div>
</section>

<div class="loading"></div>

<!--custom javascript for handling subscription-->
<script>
  var loadingScreen = $('.loading')
  var money = $('.lead')[1].innerText
  var idProduct = $('.hidden').innerText
  console.log(money)
  $(function () {
    var API_KEY = $('#api-key').val();
    // Create a Stripe client.
    var stripe = Stripe(API_KEY);

    // Create an instance of Elements.
    var elements = stripe.elements();

    // Create an instance of the card Element.
    var card = elements.create('card');

    // Add an instance of the card Element into the `card-element` <div>.
    card.mount('#card-element');

    // Handle real-time validation errors from the card Element.
    card.addEventListener('change', function (event) {
      var displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });

    // Handle form submission.
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function (event) {
      event.preventDefault();
      // handle payment
      handlePayments();
    });

    //handle card submission
    function handlePayments() {
      loadingScreen.addClass('active')
      stripe.createToken(card).then(function (result) {
        if (result.error) {
          // Inform the user if there was an error.
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          // Send the token to your server.
          var token = result.token.id;
          console.log(token)
          var email = $('#email').val();
          $.post(
                  "/create-charge",
                  {email: email, token: token, money: money, idProduct: idProduct},
                  function (data) {
                    alert(data.details);
                  }, 'json');
          loadingScreen.removeClass('active')
        }
      });
    }
  });
</script>

</body>
</html>